import React, { useState } from 'react';
import { Trash2, Eye, Table, Plus, X, Save } from 'lucide-react';

const SederMishna = () => {
  const [masechtot, setMasechtot] = useState({});
  const [viewingMasechet, setViewingMasechet] = useState(null);
  const [editingTables, setEditingTables] = useState(null);
  const [newMasechet, setNewMasechet] = useState({ title: '', author: '', pdfData: null });
  const [newComment, setNewComment] = useState('');
  const [newTable, setNewTable] = useState({ title: '', rows: 2, cols: 2, data: [] });
  const [showTableBuilder, setShowTableBuilder] = useState(false);

  const handleAddMasechet = () => {
    if (!newMasechet.title.trim()) {
      alert('יש להזין שם למסכת');
      return;
    }
    const id = 'id' + Math.random().toString(36).slice(2, 9);
    const masechet = {
      id, title: newMasechet.title, author: newMasechet.author,
      pdfData: newMasechet.pdfData, views: 0, comments: [], tables: []
    };
    setMasechtot({ ...masechtot, [id]: masechet });
    setNewMasechet({ title: '', author: '', pdfData: null });
  };

  const handleFileUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      if (file.size > 5 * 1024 * 1024) {
        alert('הקובץ גדול מדי. מקסימום 5MB');
        return;
      }
      const reader = new FileReader();
      reader.onload = () => setNewMasechet({ ...newMasechet, pdfData: reader.result });
      reader.onerror = () => alert('שגיאה בקריאת הקובץ');
      reader.readAsDataURL(file);
    }
  };

  const openMasechet = (id) => {
    const masechet = masechtot[id];
    const updated = { ...masechet, views: masechet.views + 1 };
    setMasechtot({ ...masechtot, [id]: updated });
    setViewingMasechet(updated);
  };

  const deleteMasechet = (id) => {
    if (confirm('האם למחוק את הפריט?')) {
      const newMasechtot = { ...masechtot };
      delete newMasechtot[id];
      setMasechtot(newMasechtot);
    }
  };

  const addComment = () => {
    if (!newComment.trim()) return;
    const comment = { text: newComment, when: new Date().toLocaleString('he-IL') };
    const updated = {
      ...viewingMasechet,
      comments: [...(viewingMasechet.comments || []), comment]
    };
    setMasechtot({ ...masechtot, [viewingMasechet.id]: updated });
    setViewingMasechet(updated);
    setNewComment('');
  };

  const initTableBuilder = () => {
    const data = Array(newTable.rows).fill(null).map(() => Array(newTable.cols).fill(''));
    setNewTable({ ...newTable, data });
    setShowTableBuilder(true);
  };

  const updateTableCell = (row, col, value) => {
    const newData = [...newTable.data];
    newData[row][col] = value;
    setNewTable({ ...newTable, data: newData });
  };

  const saveTable = () => {
    if (!newTable.title.trim()) {
      alert('יש להזין כותרת לטבלה');
      return;
    }
    const tableHtml = `<table style="width:100%;border-collapse:collapse;">
      ${newTable.data.map(row => `<tr>${row.map(cell => 
        `<td style="border:1px solid #ddd;padding:6px;">${cell || ''}</td>`
      ).join('')}</tr>`).join('')}
    </table>`;
    const table = { title: newTable.title, html: tableHtml };
    const updated = {
      ...editingTables,
      tables: [...(editingTables.tables || []), table]
    };
    setMasechtot({ ...masechtot, [editingTables.id]: updated });
    setEditingTables(updated);
    setNewTable({ title: '', rows: 2, cols: 2, data: [] });
    setShowTableBuilder(false);
  };

  const deleteTable = (idx) => {
    if (confirm('האם למחוק את הטבלה?')) {
      const tables = [...editingTables.tables];
      tables.splice(idx, 1);
      const updated = { ...editingTables, tables };
      setMasechtot({ ...masechtot, [editingTables.id]: updated });
      setEditingTables(updated);
    }
  };

  const exportData = () => {
    const dataStr = JSON.stringify(masechtot, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'seder_mishna_export.json';
    a.click();
    URL.revokeObjectURL(url);
  };

  if (!viewingMasechet && !editingTables) {
    return (
      <div className="min-h-screen bg-gray-50 p-4" dir="rtl">
        <div className="max-w-6xl mx-auto">
          <div className="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div className="flex justify-between items-start mb-4">
              <div>
                <h1 className="text-3xl font-bold mb-2">סדר למשנה</h1>
                <p className="text-gray-600">מערכת פשוטה להצגת חוברות ומסכתות - קריאה, טבלאות ותגובות</p>
              </div>
              <div className="flex gap-2">
                <button onClick={exportData} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2">
                  <Save size={18} />ייצא JSON
                </button>
                <button onClick={() => { if (confirm('לאפס את כל המידע? זה ימחוק הכל.')) setMasechtot({}); }}
                  className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                  איפוס
                </button>
              </div>
            </div>
          </div>

          <div className="bg-white rounded-lg shadow-sm p-6 mb-6">
            <h2 className="text-xl font-bold mb-4">הוסף מסכת / חוברת חדשה</h2>
            <div className="space-y-3">
              <div className="flex gap-3">
                <input type="text" value={newMasechet.title}
                  onChange={(e) => setNewMasechet({ ...newMasechet, title: e.target.value })}
                  onKeyPress={(e) => e.key === 'Enter' && handleAddMasechet()}
                  placeholder="שם המסכת / כותרת החוברת"
                  className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
                <input type="text" value={newMasechet.author}
                  onChange={(e) => setNewMasechet({ ...newMasechet, author: e.target.value })}
                  placeholder="מחבר (אופציונלי)"
                  className="w-48 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
                <input type="file" accept="application/pdf" onChange={handleFileUpload}
                  className="w-64 px-3 py-2 border border-gray-300 rounded-lg" />
                <button onClick={handleAddMasechet}
                  className="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center gap-2">
                  <Plus size={18} />הוסף
                </button>
              </div>
              <p className="text-sm text-gray-500">הנתונים נשמרים בזיכרון במהלך הפעלה זו. לשמירה קבועה יש לייצא JSON.</p>
            </div>
          </div>

          <div className="space-y-4">
            {Object.keys(masechtot).length === 0 ? (
              <div className="bg-white rounded-lg shadow-sm p-8 text-center text-gray-500">
                אין מסכתות - הוסף מסכת חדשה
              </div>
            ) : (
              Object.values(masechtot).map((m) => (
                <div key={m.id} className="bg-white rounded-lg shadow-sm p-6">
                  <div className="flex justify-between items-start">
                    <div>
                      <h3 className="text-xl font-bold mb-1">{m.title}</h3>
                      <p className="text-gray-600 mb-2">{m.author || '—'}</p>
                      <div className="text-sm text-gray-500">
                        <span className="ml-4">צפיות: {m.views || 0}</span>
                        <span className="ml-4">תגובות: {(m.comments || []).length}</span>
                        <span>טבלאות: {(m.tables || []).length}</span>
                      </div>
                    </div>
                    <div className="flex gap-2">
                      <button onClick={() => openMasechet(m.id)}
                        className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2">
                        <Eye size={18} />פתח
                      </button>
                      <button onClick={() => setEditingTables(m)}
                        className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center gap-2">
                        <Table size={18} />טבלאות
                      </button>
                      <button onClick={() => deleteMasechet(m.id)}
                        className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                        <Trash2 size={18} />
                      </button>
                    </div>
                  </div>
                </div>
              ))
            )}
          </div>
        </div>
      </div>
    );
  }

  if (viewingMasechet) {
    return (
      <div className="min-h-screen bg-gray-50 p-4" dir="rtl">
        <div className="max-w-6xl mx-auto">
          <button onClick={() => setViewingMasechet(null)}
            className="mb-4 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 flex items-center gap-2">
            <X size={18} />חזור לרשימה
          </button>

          <div className="bg-white rounded-lg shadow-sm p-6 mb-6">
            <h1 className="text-3xl font-bold mb-2">{viewingMasechet.title}</h1>
            <p className="text-gray-600">מחבר: {viewingMasechet.author || '—'}</p>
          </div>

          {viewingMasechet.pdfData && (
            <div className="bg-white rounded-lg shadow-sm p-6 mb-6">
              <h2 className="text-xl font-bold mb-4">מסמך PDF</h2>
              <iframe src={viewingMasechet.pdfData}
                className="w-full h-[700px] border border-gray-300 rounded" />
            </div>
          )}

          <div className="bg-white rounded-lg shadow-sm p-6 mb-6">
            <h2 className="text-xl font-bold mb-4">טבלאות מקושרות</h2>
            {(viewingMasechet.tables || []).length === 0 ? (
              <p className="text-gray-500">אין טבלאות</p>
            ) : (
              <div className="space-y-4">
                {viewingMasechet.tables.map((table, idx) => (
                  <div key={idx} className="border border-gray-200 rounded p-4">
                    <h3 className="font-bold mb-2">{table.title}</h3>
                    <div dangerouslySetInnerHTML={{ __html: table.html }} />
                  </div>
                ))}
              </div>
            )}
          </div>

          <div className="bg-white rounded-lg shadow-sm p-6">
            <h2 className="text-xl font-bold mb-4">תגובות</h2>
            <div className="space-y-3 mb-4">
              {(viewingMasechet.comments || []).map((comment, idx) => (
                <div key={idx} className="border-t border-gray-200 pt-3">
                  <div className="text-sm text-gray-500 mb-1">{comment.when}</div>
                  <div>{comment.text}</div>
                </div>
              ))}
            </div>
            <div className="flex gap-2">
              <textarea value={newComment}
                onChange={(e) => setNewComment(e.target.value)}
                placeholder="כתוב תגובה..." rows="3"
                className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
              <button onClick={addComment}
                className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 h-fit">
                שלח
              </button>
            </div>
          </div>
        </div>
      </div>
    );
  }

  if (editingTables) {
    return (
      <div className="min-h-screen bg-gray-50 p-4" dir="rtl">
        <div className="max-w-6xl mx-auto">
          <button onClick={() => {
              setEditingTables(null);
              setShowTableBuilder(false);
              setNewTable({ title: '', rows: 2, cols: 2, data: [] });
            }}
            className="mb-4 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 flex items-center gap-2">
            <X size={18} />חזור לרשימה
          </button>

          <div className="bg-white rounded-lg shadow-sm p-6 mb-6">
            <h1 className="text-2xl font-bold mb-4">עורך טבלאות: {editingTables.title}</h1>

            {!showTableBuilder ? (
              <div className="space-y-3">
                <div className="flex gap-3">
                  <input type="text" value={newTable.title}
                    onChange={(e) => setNewTable({ ...newTable, title: e.target.value })}
                    placeholder="כותרת הטבלה"
                    className="flex-1 px-3 py-2 border border-gray-300 rounded-lg" />
                  <input type="number" value={newTable.rows}
                    onChange={(e) => setNewTable({ ...newTable, rows: Math.max(1, parseInt(e.target.value) || 1) })}
                    placeholder="שורות" min="1"
                    className="w-24 px-3 py-2 border border-gray-300 rounded-lg" />
                  <input type="number" value={newTable.cols}
                    onChange={(e) => setNewTable({ ...newTable, cols: Math.max(1, parseInt(e.target.value) || 1) })}
                    placeholder="עמודות" min="1"
                    className="w-24 px-3 py-2 border border-gray-300 rounded-lg" />
                  <button onClick={initTableBuilder}
                    className="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                    צור טבלה
                  </button>
                </div>
              </div>
            ) : (
              <div className="space-y-4">
                <h3 className="font-bold">מלא את תוכן הטבלה:</h3>
                <div className="overflow-x-auto">
                  <table className="w-full border-collapse">
                    <tbody>
                      {newTable.data.map((row, i) => (
                        <tr key={i}>
                          {row.map((cell, j) => (
                            <td key={j} className="border border-gray-300 p-1">
                              <input type="text" value={cell}
                                onChange={(e) => updateTableCell(i, j, e.target.value)}
                                className="w-full px-2 py-1 border-0 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                            </td>
                          ))}
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
                <div className="flex gap-2">
                  <button onClick={saveTable}
                    className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    שמור טבלה
                  </button>
                  <button onClick={() => {
                      setShowTableBuilder(false);
                      setNewTable({ title: '', rows: 2, cols: 2, data: [] });
                    }}
                    className="px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                    ביטול
                  </button>
                </div>
              </div>
            )}
          </div>

          <div className="space-y-4">
            <h2 className="text-xl font-bold">טבלאות קיימות</h2>
            {(editingTables.tables || []).length === 0 ? (
              <div className="bg-white rounded-lg shadow-sm p-6 text-center text-gray-500">
                אין טבלאות עדיין
              </div>
            ) : (
              editingTables.tables.map((table, idx) => (
                <div key={idx} className="bg-white rounded-lg shadow-sm p-6">
                  <div className="flex justify-between items-start mb-4">
                    <h3 className="text-lg font-bold">{table.title}</h3>
                    <button onClick={() => deleteTable(idx)}
                      className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                      מחק
                    </button>
                  </div>
                  <div dangerouslySetInnerHTML={{ __html: table.html }} />
                </div>
              ))
            )}
          </div>
        </div>
      </div>
    );
  }
};

export default SederMishna;
